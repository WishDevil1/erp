apiVersion: v1
kind: Service
metadata:
  name: metasfresh-{{ .Release.Name }}-webui
  namespace: {{ .Release.Namespace }}
  labels:
    app: metasfresh-{{ .Release.Name }}-webui
spec:
  ports:
  - name: webui-http
    port: {{ .Values.webui.port.http }}
    protocol: TCP
    targetPort: {{ .Values.webui.port.http }}
  - name: webui-https
    port: {{ .Values.webui.port.https }}
    protocol: TCP
    targetPort: {{ .Values.webui.port.https }}
  selector:
    app: metasfresh-{{ .Release.Name }}-webui
  sessionAffinity: None

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: metasfresh-{{ .Release.Name }}-webui
  namespace: {{ .Release.Namespace }}
  labels:
    app: metasfresh-{{ .Release.Name }}-webui
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: metasfresh-{{ .Release.Name }}-webui
  template:
    metadata:
      labels:
        app: metasfresh-{{ .Release.Name }}-webui
    spec:
      containers:
      - name: metasfresh-{{ .Release.Name }}-webui
        image: {{ .Values.webui.image }}
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: {{ .Values.webui.port.http }}
        - containerPort: {{ .Values.webui.port.https }}
        env:
        - name: WEBUI_API_CLIENT_PROTOCOL
          value: {{ .Values.webui.webuiAPIClient.protocol }}
        - name: WEBUI_API_CLIENT_HOST
          value: {{ .Values.ingress.webui.url }}
        - name: WEBUI_API_CLIENT_PORT
          value: '{{ .Values.webui.webuiAPIClient.port }}'
        - name: WEBUI_API_PROXYPASS_PROTOCOL
          value: {{ .Values.webui.webuiAPIProxypass.protocol }}
        - name: WEBUI_API_PROXYPASS_HOST
          value: metasfresh-{{ .Release.Name }}-webapi
        - name: WEBUI_API_PROXYPASS_PORT
          value: '{{ .Values.webapi.port.webapi }}'  
        volumeMounts:
        - mountPath: /etc/localtime
          name: host-localtime
          readOnly: true
        - mountPath: /etc/timezone
          name: host-timezone
          readOnly: true
      restartPolicy: Always
      initContainers:
      - name: init-wait-for-webapi
        image: busybox
        command: ['sh', '-c', 'until nc -vz metasfresh-{{ .Release.Name }}-webapi {{ .Values.webapi.port.webapi }}; do echo waiting for webapi; sleep 2; done;']
      volumes:
      - name: host-localtime
        hostPath:
          path: /etc/localtime
      - name: host-timezone
        hostPath:
          path: /etc/timezone
